hostname serviceLeaf01
password zebra
enable password zebra
!
log syslog informational
log facility local4
!
agentx
no service integrated-vtysh-config
!
!
vrf Vrf_CustPriv01
vni 11011
exit-vrf
!
vrf Vrf-Public
vni 11001
exit-vrf
!
!
!! fw01
interface PortChannel4
 evpn mh es-sys-mac 00:00:01:00:00:04
 evpn mh es-id 1
 exit
 !
!! fw02
interface PortChannel5
 evpn mh es-sys-mac 00:00:01:00:00:05
 evpn mh es-id 1
 exit
!
!
! Set ip source to loopback for bgp learned routes
route-map RM_SET_SRC permit 10
    set src 10.20.0.1
!
ip protocol bgp route-map RM_SET_SRC
!
!
ip prefix-list from_CustPub01Fw seq 10 permit 83.246.100.0/29
ip prefix-list from_CustPriv01Fw seq 10 permit 0.0.0.0/0
ip prefix-list to_CustPriv01 seq 10 permit 10.10.10.0/24
!
route-map from_CustPub01Fw permit 10
 match ip address prefix-list from_CustPub01Fw
 exit
!
!
route-map to_CustPriv01 permit 10
 match ip address prefix-list to_CustPriv01
 exit
!
!
route-map from_CustPrivFw01 permit 10
 match ip next-hop address 10.255.0.4
 set as-path prepend last-as 5
exit
!
route-map from_CustPrivFw01 permit 20
 match ip next-hop address 10.255.0.3
exit
!
route-map from_CustPrivFw01 permit 30
 match ip address prefix-list from_CustPriv01Fw 
exit
!
!
route-map from_CustPubFw01 permit 10
 match ip next-hop address 10.254.0.4
 set as-path prepend last-as 5
exit
!
route-map from_CustPubFw01 permit 20
 match ip next-hop address 10.254.0.3
exit
!
route-map from_CustPubFw01 permit 30
 match ip address prefix-list from_CustPub01Fw 
exit
!
router bgp 65001 vrf Vrf-Public
!
router bgp 65001 vrf Vrf_CustPriv01
!
router bgp 65001
!
router bgp 65001 vrf Vrf-Public
 bgp router-id 10.254.0.1
 bgp log-neighbor-changes
 no bgp default ipv4-unicast
 bgp network import-check
 timers bgp 1 3
 neighbor to_Firewall peer-group
 neighbor to_Firewall bfd
 neighbor to_Firewall remote-as external
 neighbor to_Firewall local-as 65201 no-prepend replace-as
 no neighbor to_Firewall shutdown
 neighbor to_Firewall advertisement-interval 0
 neighbor to_Firewall timers connect 30
 neighbor 10.254.0.3 peer-group to_Firewall
 neighbor 10.254.0.4 peer-group to_Firewall
 !
 address-family ipv4 unicast
  redistribute connected
  neighbor to_Firewall activate
  neighbor to_Firewall default-originate
  neighbor to_Firewall route-map to_CustPriv01 out
  neighbor to_Firewall route-map from_CustPubFw01 in
  maximum-paths 2
 exit-address-family
 !
 address-family l2vpn evpn
  advertise-default-gw
  advertise ipv4 unicast 
 exit-address-family
 exit
!
router bgp 65001 vrf Vrf_CustPriv01
 bgp router-id 10.254.0.1
 bgp log-neighbor-changes
 no bgp default ipv4-unicast
 bgp network import-check
 timers bgp 1 3
 neighbor to_Firewall peer-group
 neighbor to_Firewall bfd
 neighbor to_Firewall remote-as external
 neighbor to_Firewall local-as 65200 no-prepend replace-as
 no neighbor to_Firewall shutdown
 neighbor to_Firewall advertisement-interval 0
 neighbor to_Firewall timers connect 30
 neighbor 10.255.0.3 peer-group to_Firewall
 neighbor 10.255.0.4 peer-group to_Firewall
 !
 address-family ipv4 unicast
  redistribute connected
  neighbor to_Firewall activate
  neighbor to_Firewall route-map to_CustPriv01 out
  neighbor to_Firewall route-map from_CustPrivFw01 in
  maximum-paths 2
 exit-address-family
 !
 address-family l2vpn evpn
  advertise-default-gw
  advertise-pip
  advertise ipv4 unicast
 exit-address-family
 exit
!
router bgp 65001
 bgp router-id 10.20.0.1
 bgp log-neighbor-changes
 no bgp ebgp-requires-policy
 no bgp default ipv4-unicast
 bgp network import-check
 timers bgp 1 3
 neighbor overlay peer-group
 neighbor overlay bfd
 neighbor overlay remote-as external
 neighbor overlay ebgp-multihop 3
 neighbor overlay advertisement-interval 0
 neighbor overlay timers connect 30
 no neighbor overlay shutdown
 neighbor Ethernet0 interface peer-group underlay
 !
 neighbor underlay peer-group
 neighbor underlay bfd
 neighbor underlay remote-as external
 neighbor underlay advertisement-interval 0
 neighbor underlay timers connect 30
 neighbor underlay capability extended-nexthop
 no neighbor underlay shutdown
 neighbor 10.10.0.1 peer-group overlay
 !
 address-family ipv4 unicast
 redistribute connected
  neighbor underlay activate
  maximum-paths 1
 exit-address-family
 !
 address-family l2vpn evpn
  neighbor overlay activate
  advertise-all-vni
 exit-address-family
 exit
!
